#!/bin/sh -xv
. "$(dirname "$0")/_/husky.sh"

# ### git commit message template ###
git config commit.template .git/templatemessage
TICKETID=`git rev-parse --abbrev-ref HEAD | LC_ALL=en_US.utf8 grep -oP '((feature|bug|bugfix|fix|hotfix|task|chore)\/)\K\d{1,7}'`
echo "[POST_CHECKOUT] Setting template commit to $TICKETID"
echo "#$TICKETID: " > ".git/templatemessage"



# ### run npm install ###
echo "[POST-CHECKOUT-1]"
IFS=$'\n'
echo "[POST-CHECKOUT-2]"
# regex supports mono-repos with a package.json at root-level and at package-level
PACKAGE_LOCK_REGEX="(^packages\/.*\/package-lock\.json)|(^package-lock\.json)"
echo "[POST-CHECKOUT-3]"
# extract all paths to package-lock.json files 
PACKAGES=("$(git diff --name-only HEAD@{1} HEAD | grep -E "$PACKAGE_LOCK_REGEX")")
echo "[POST-CHECKOUT-4]"

if [[ ${PACKAGES[@]} ]]; then
  for package in $PACKAGES; do
    echo "[POST-CHECKOUT]"
    echo "ðŸ“¦ $package was changed. Running npm install to update your dependencies..."
    DIR=$(dirname package)
    cd "$DIR" && npm install
  done
fi